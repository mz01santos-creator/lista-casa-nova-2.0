<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Casa Nova</title>

  <style>
    :root{
      --bg:#f6f3fb;
      --card:#ffffff;
      --text:#1c1b22;
      --muted:#6b6880;
      --primary:#7b6cff;
      --primary2:#a58bff;
      --line:rgba(0,0,0,.08);
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      padding:18px 16px 14px;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.2);
    }

    .wrap{max-width:1040px;margin:0 auto;padding:0 12px}
    h1{margin:0 0 10px;font-size:20px;letter-spacing:.2px}

    .top{display:grid;gap:10px}

    input[type="search"]{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:none;
      outline:none;
      font-size:14px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .left, .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.25);
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
    }

    .progress{
      height:10px;
      width:220px;
      background:rgba(255,255,255,.25);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.25);
    }
    .bar{height:100%;width:0%;background:#fff;transition:width .25s ease}

    button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.22)}
    button.secondary{
      background:rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.18);
    }

    main{padding:18px 0 28px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(290px,1fr));
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px 10px;
      box-shadow:var(--shadow);
    }

    .card h2{margin:0 0 6px;font-size:16px}
    .meta{color:var(--muted);font-size:12px;margin-bottom:10px}

    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:7px 0;
      border-top:1px dashed rgba(0,0,0,.06);
    }
    .item:first-of-type{border-top:none}

    .item input{
      margin-top:2px;
      transform:scale(1.18);
      accent-color:var(--primary);
    }

    .item label{line-height:1.25}
    .done label{color:var(--muted); text-decoration:line-through}

    footer{
      text-align:center;
      color:var(--muted);
      padding:18px 0 26px;
      font-size:12px;
    }

    .small{
      font-size:12px;
      opacity:.9;
    }

    @media (max-width:540px){
      .progress{width:160px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <h1>Lista de Casa Nova</h1>

    <input id="search" type="search" placeholder="Buscar item (ex: toalha, panela, cama)..." autocomplete="off" />

    <div class="row">
      <div class="left">
        <span class="pill" id="summary">Carregando...</span>
        <div class="pill">
          <span class="small">Progresso</span>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>
      </div>

      <div class="right">
        <button id="toggleMissing" class="secondary">Mostrar só faltando</button>
        <button id="checkAll">Marcar tudo</button>
        <button id="clearAll" class="secondary">Limpar tudo</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid" id="grid"></div>
  </div>
</main>

<footer>
  Salva automaticamente e sincroniza entre navegadores.
</footer>

<script>
  // ====== Dados (itens da imagem) ======
  const DATA = {
    "Cozinha": [
      "Geladeira",
      "Fogão ou cooktop",
      "Micro-ondas",
      "Liquidificador",
      "Batedeira",
      "Torradeira",
      "Cafeteira",
      "Processador de alimentos",
      "Panela elétrica de arroz",
      "Air fryer",
      "Panelas de diferentes tamanhos",
      "Frigideiras",
      "Formas para bolo e assadeiras",
      "Talheres",
      "Facas de cozinha",
      "Tábuas de corte",
      "Colheres de pau e espátulas",
      "Peneiras e escorredores",
      "Tigelas e batedores de ovos",
      "Conchas, escumadeiras e pegadores",
      "Pratos (rasos, fundos e sobremesa)",
      "Copos e taças (água, vinho, cerveja)",
      "Xícaras e pires",
      "Potes para armazenamento",
      "Jarras e garrafas térmicas",
      "Guardanapos e porta-guardanapos",
      "Jogos americanos e toalhas de mesa"
    ],
    "Sala": [
      "Sofá",
      "Poltronas",
      "Mesa de centro",
      "Estante ou rack para TV",
      "Mesa de jantar e cadeiras",
      "Aparador",
      "Tapetes",
      "Almofadas",
      "Cortinas ou persianas",
      "Luminárias e abajures",
      "Quadros e espelhos",
      "Plantas e vasos decorativos"
    ],
    "Quarto": [
      "Cama (box, colchão)",
      "Cabeceira",
      "Criados-mudos",
      "Guarda-roupa ou closet",
      "Cômoda",
      "Jogos de lençol",
      "Edredons e cobertores",
      "Travesseiros",
      "Almofadas decorativas",
      "Protetor de colchão"
    ],
    "Banheiro": [
      "Toalhas de banho e rosto",
      "Tapetes de banheiro",
      "Cortina de chuveiro",
      "Porta sabonete e porta escova",
      "Espelho",
      "Cesto de roupa suja",
      "Escova de vaso sanitário",
      "Prateleiras ou armário para armazenamento",
      "Kit de primeiros socorros"
    ],
    "Lavanderia": [
      "Máquina de lavar roupa",
      "Secadora (opcional)",
      "Ferro de passar roupa",
      "Tábua de passar roupa",
      "Cesto de roupas",
      "Pregadores e varal",
      "Produtos de limpeza",
      "Baldes e bacias",
      "Aspirador de pó",
      "Vassouras e rodos",
      "Panos de chão e de limpeza",
      "Esponjas e escovas",
      "Baldes",
      "Produtos de limpeza diversos"
    ]
  };

  // ====== Sincronização KV (Cloudflare Pages Functions) ======
  const API_URL = "/api/state";
  const CACHE_KEY = "lista_cache_v1";

  let state = {}; // { "Cozinha::geladeira": true, ... }
  let showOnlyMissing = false;
  let saveTimer = null;

  const grid = document.getElementById("grid");
  const search = document.getElementById("search");
  const summary = document.getElementById("summary");
  const bar = document.getElementById("bar");
  const toggleMissingBtn = document.getElementById("toggleMissing");
  const checkAllBtn = document.getElementById("checkAll");
  const clearAllBtn = document.getElementById("clearAll");

  function uid(section, item) {
    return `${section}::${item}`.toLowerCase();
  }

  function debounceSave() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveState(), 300);
  }

  async function loadState() {
    // tenta servidor
    try {
      const res = await fetch(API_URL, { cache: "no-store" });
      if (res.ok) {
        state = await res.json();
        localStorage.setItem(CACHE_KEY, JSON.stringify(state));
        return;
      }
    } catch {}

    // fallback local
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      state = raw ? JSON.parse(raw) : {};
    } catch {
      state = {};
    }
  }

  async function saveState() {
    const body = JSON.stringify(state);
    localStorage.setItem(CACHE_KEY, body);

    try {
      await fetch(API_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body
      });
    } catch {}
  }

  // ====== UI ======
  function computeTotals(filterText = "") {
    let total = 0;
    let done = 0;

    for (const [section, items] of Object.entries(DATA)) {
      for (const item of items) {
        const key = uid(section, item);
        const checked = !!state[key];

        const match = !filterText || item.toLowerCase().includes(filterText) || section.toLowerCase().includes(filterText);
        if (!match) continue;

        if (showOnlyMissing && checked) continue;

        total++;
        if (checked) done++;
      }
    }
    return { total, done };
  }

  function render() {
    const q = (search.value || "").trim().toLowerCase();

    grid.innerHTML = "";

    for (const [section, items] of Object.entries(DATA)) {
      const card = document.createElement("div");
      card.className = "card";

      const h2 = document.createElement("h2");
      h2.textContent = section;

      const meta = document.createElement("div");
      meta.className = "meta";

      // Conteúdo
      const fragment = document.createDocumentFragment();
      let sectionVisibleCount = 0;
      let sectionDone = 0;

      for (const item of items) {
        const key = uid(section, item);
        const checked = !!state[key];

        const match = !q || item.toLowerCase().includes(q) || section.toLowerCase().includes(q);
        if (!match) continue;

        if (showOnlyMissing && checked) continue;

        sectionVisibleCount++;
        if (checked) sectionDone++;

        const row = document.createElement("div");
        row.className = "item" + (checked ? " done" : "");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = checked;

        cb.addEventListener("change", () => {
          state[key] = cb.checked;
          row.className = "item" + (cb.checked ? " done" : "");
          debounceSave();
          updateHeader();
          // se estiver em "só faltando", some ao marcar
          if (showOnlyMissing && cb.checked) render();
        });

        const label = document.createElement("label");
        label.textContent = item;

        row.appendChild(cb);
        row.appendChild(label);
        fragment.appendChild(row);
      }

      // Se não tem nada a mostrar nessa seção, não renderiza o card
      if (sectionVisibleCount === 0) continue;

      meta.textContent = `${sectionDone}/${sectionVisibleCount} concluídos (visíveis)`;

      card.appendChild(h2);
      card.appendChild(meta);
      card.appendChild(fragment);
      grid.appendChild(card);
    }

    updateHeader();
  }

  function updateHeader() {
    const q = (search.value || "").trim().toLowerCase();
    const { total, done } = computeTotals(q);

    // total aqui é o total visível; done é o concluído visível
    summary.textContent = `${done} / ${total} concluídos`;

    const percent = total === 0 ? 0 : Math.round((done / total) * 100);
    bar.style.width = percent + "%";

    toggleMissingBtn.textContent = showOnlyMissing ? "Mostrar tudo" : "Mostrar só faltando";
  }

  // ====== Ações ======
  toggleMissingBtn.addEventListener("click", () => {
    showOnlyMissing = !showOnlyMissing;
    render();
  });

  checkAllBtn.addEventListener("click", () => {
    const q = (search.value || "").trim().toLowerCase();
    for (const [section, items] of Object.entries(DATA)) {
      for (const item of items) {
        const match = !q || item.toLowerCase().includes(q) || section.toLowerCase().includes(q);
        if (!match) continue;
        state[uid(section, item)] = true;
      }
    }
    debounceSave();
    render();
  });

  clearAllBtn.addEventListener("click", () => {
    const q = (search.value || "").trim().toLowerCase();
    for (const [section, items] of Object.entries(DATA)) {
      for (const item of items) {
        const match = !q || item.toLowerCase().includes(q) || section.toLowerCase().includes(q);
        if (!match) continue;
        delete state[uid(section, item)];
      }
    }
    debounceSave();
    render();
  });

  search.addEventListener("input", () => render());

  // ====== Inicialização ======
  loadState().then(render);
</script>
</body>
</html>
